!function(){"use strict";function e(){try{var e=document.createElement("canvas");return!(!window.hasOwnProperty("WebGLRenderingContext")||!window.WebGLRenderingContext||!e.getContext("webgl")&&!e.getContext("experimental-webgl"))}catch(o){return!1}}function o(e){return JSON.parse(JSON.stringify(e))}function t(e){if("string"!=typeof e)return!1;var o=e.split("-");return 2!==o.length?!1:n(o[0])&&n(o[1])}function n(e){return r(e)||i(e)}function r(e){return"string"!=typeof e?!1:-1!==e.search(/^[a-h][1-8]$/)}function i(e){return"string"!=typeof e?!1:-1!==e.search(/^s[bw][1-6]$/)}function a(e){return"string"!=typeof e?!1:-1!==e.search(/^[bw][KQRNBP]$/)}function s(e){if("string"!=typeof e)return!1;e=e.replace(/ .+$/,"");var o=e.split("/");if(8!==o.length)return!1;for(var t=0;8>t;t++)if(""===o[t]||o[t].length>8||-1!==o[t].search(/[^kqrbnpKQRNBP1-8]/))return!1;return!0}function p(e){if("object"!=typeof e)return!1;for(var o in e)if(e.hasOwnProperty(o)===!0&&(n(o)!==!0||a(e[o])!==!0))return!1;return!0}function c(e){return e.toLowerCase()===e?"b"+e.toUpperCase():"w"+e.toUpperCase()}function l(e){var o=e.split("");return"w"===o[0]?o[1].toUpperCase():o[1].toLowerCase()}function u(e){if(s(e)!==!0)return!1;e=e.replace(/ .+$/,"");for(var o=e.split("/"),t={},n=8,r=0;8>r;r++){for(var i=o[r].split(""),a=0,p=0;p<i.length;p++)if(-1!==i[p].search(/[1-8]/))a+=parseInt(i[p],10);else{var l=w[a]+n;t[l]=c(i[p]),a++}n--}return t}function d(e){if(p(e)!==!0)return!1;for(var o="",t=8,n=0;8>n;n++){for(var r=0;8>r;r++){var i=w[r]+t;o+=e.hasOwnProperty(i)===!0?l(e[i]):"1"}7!==n&&(o+="/"),t--}return o=o.replace(/11111111/g,"8"),o=o.replace(/1111111/g,"7"),o=o.replace(/111111/g,"6"),o=o.replace(/11111/g,"5"),o=o.replace(/1111/g,"4"),o=o.replace(/111/g,"3"),o=o.replace(/11/g,"2")}var f=71,h="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",w="abcdefgh".split(""),v=[[50,40,30],[-50,0,-30]],E=2,y=Math.PI/4,m=18.25,g={sw1:"wK",sw2:"wQ",sw3:"wR",sw4:"wB",sw5:"wN",sw6:"wP",sb1:"bK",sb2:"bQ",sb3:"bR",sb4:"bB",sb5:"bN",sb6:"bP"},b=500,P=.75;window.ChessBoard3=window.ChessBoard3||function(n,a){function c(e,o,t){a.showErrors;if(a.hasOwnProperty("showErrors")===!0&&a.showErrors!==!1){var n="ChessBoard3 Error "+e+": "+o;return a.hasOwnProperty("showErrors")&&"console"===a.showErrors&&"object"==typeof console&&"function"==typeof console.log?(console.log(n),void(arguments.length>=2&&console.log(t))):"alert"===a.showErrors?(t&&(n+="\n\n"+JSON.stringify(t)),void window.alert(n)):void("function"==typeof a.showErrors&&a.showErrors.call(e,o,t))}}function l(){if(void 0===THREE||void 0===THREE.REVISION||isNaN(parseInt(THREE.REVISION))||parseInt(THREE.REVISION)<f)return console.log("ChessBoard3 Error 3006: Unable to find three.js revision 71 or greater. \n\nExiting..."),!1;if(!window.JSON||"function"!=typeof JSON.stringify||"function"!=typeof JSON.parse)return window.alert("ChessBoard3 Error 1004: JSON does not exist in this browser. Please include a JSON polyfill.\n\nExiting..."),!1;if(!e())return window.alert("ChessBoard3 Error 3001: WebGL is not enabled.\n\nExiting..."),!1;if("string"==typeof n){if(""===n)return window.alert("ChessBoard3 Error 1001: The first argument to ChessBoard3() cannot be an empty string.\n\nExiting..."),!1;var o=document.getElementById(n);if(!o)return window.alert('ChessBoard Error 1002: Element with id "'+n+'"does not exist in the DOM.\n\nExiting...'),!1;we=o}else if(we=n,-1!==we.length)return window.alert("ChessBoard3 Error 1003: The first argument to ChessBoard3() must be an ID or a single DOM node.\n\nExiting..."),!1;return!0}function S(e){return"fast"===e||"slow"===e?!0:parseInt(e,10)+""!=e+""?!1:e>=0}function O(){return("string"==typeof a||p(a))&&(a={position:a}),"black"!==a.orientation&&(a.orientation="white"),Ge=a.orientation,a.showNotation!==!1&&(a.showNotation=!0),a.draggable!==!0&&(a.draggable=!1),"trash"!==a.dropOffBoard&&(a.dropOffBoard="snapback"),a.sparePieces!==!0&&(a.sparePieces=!1),a.sparePieces===!0&&(a.draggable=!0),(a.hasOwnProperty("pieceSet")!==!0||"string"!=typeof a.pieceSet&&"function"!=typeof a.pieceSet)&&(a.pieceSet="assets/chesspieces/iconic/{piece}.json"),a.rotateControls!==!1&&(a.rotateControls=!0),a.zoomControls!==!0&&(a.zoomControls=!1),a.hasOwnProperty("appearSpeed")!==!0||S(a.appearSpeed)!==!0?a.appearSpeed=200:a.hasOwnProperty("appearSpeed")&&("slow"===a.appearSpeed?a.appearSpeed=400:"fast"===a.appearSpeed&&(a.appearSpeed=100)),a.hasOwnProperty("moveSpeed")!==!0||S(a.moveSpeed)!==!0?a.moveSpeed=200:a.hasOwnProperty("moveSpeed")&&("slow"===a.moveSpeed?a.moveSpeed=400:"fast"===a.moveSpeed&&(a.moveSpeed=100)),a.hasOwnProperty("snapbackSpeed")!==!0||S(a.snapbackSpeed)!==!0?a.snapbackSpeed=50:a.hasOwnProperty("snapbackSpeed")&&("slow"===a.snapbackSpeed?a.snapbackSpeed=100:"fast"===a.snapbackSpeed&&(a.snapbackSpeed=25)),a.hasOwnProperty("snapSpeed")!==!0||S(a.snapSpeed)!==!0?a.snapSpeed=25:a.hasOwnProperty("snapSpeed")&&("slow"===a.snapSpeed?a.snapSpeed=50:"fast"===a.snapSpeed&&(a.snapSpeed=10)),a.hasOwnProperty("trashSpeed")!==!0||S(a.trashSpeed)!==!0?a.trashSpeed=100:a.hasOwnProperty("trashSpeed")&&("slow"===a.trashSpeed?a.trashSpeed=200:"fast"===a.trashSpeed&&(a.trashSpeed=50)),a.hasOwnProperty("position")===!0&&("start"===a.position?Ue=o(be):s(a.position)===!0?Ue=u(a.position):p(a.position)===!0?Ue=o(a.position):c(7263,"Invalid value passed to config.position.",a.position)),!0}function x(){"black"!==a.orientation&&(a.orientation="white"),ve=new THREE.WebGLRenderer({alpha:!0,preserveDrawingBuffer:!0,antialias:!0,transparent:!0});var e;e=a.hasOwnProperty("backgroundColor")&&"number"==typeof a.backgroundColor?a.backgroundColor:12303291,ve.setClearColor(e,1),ve.setSize(we.clientWidth,Math.round(we.clientWidth*P)),Ee=new THREE.Scene,me=new THREE.PerspectiveCamera(60,we.clientWidth/we.clientHeight,.1,1e3),me.aspectRatio=P,a.sparePieces===!1&&(Oe.multiplyScalar(.9),xe.multiplyScalar(.9)),"white"===a.orientation?me.position.set(Oe.x,Oe.y,Oe.z):"black"===a.orientation&&me.position.set(xe.x,xe.y,xe.z),me.lookAt(new THREE.Vector3(0,-3,0)),Ee.add(me),ve.domElement.addEventListener("mousedown",ce,!0),ve.domElement.addEventListener("mousemove",le,!0),ve.domElement.addEventListener("mouseup",ue,!0),"ontouchstart"in document.documentElement&&(ve.domElement.addEventListener("touchstart",function(e){ce(e,!0)},!0),ve.domElement.addEventListener("touchmove",function(e){le(e,!0)},!0),ve.domElement.addEventListener("touchend",ue,!0)),(a.rotateControls||a.zoomControls)&&void 0!==THREE.OrbitControls&&(ge=new THREE.OrbitControls(me,ve.domElement,ve.domElement),ge.noPan=!0,a.rotateControls?(ge.minPolarAngle=Math.PI/2*.1,ge.maxPolarAngle=Math.PI/2*.8):ge.noRotate=!0,a.zoomControls?(ge.minDistance=12,ge.maxDistance=22):ge.noZoom=!0,ge.target.y=-3,ge.enabled=!0)}function C(e){Ve=!0;var o=me.position,t=o.y,n=e.y,r=Math.sqrt(Math.pow(o.x,2)+Math.pow(o.z,2)),i=Math.sqrt(Math.pow(e.x,2)+Math.pow(e.z,2)),a=Math.acos(o.x/r),s=Math.acos(e.x/i);o.z<0&&(a=-a),e.z<0&&(s=-s),(s-a>=Math.PI||a-s>Math.PI)&&(s>a?s-=2*Math.PI:s+=2*Math.PI);var p=function(){me.position.set(e.x,e.y,e.z),me.lookAt(new THREE.Vector3(0,-3,0)),Ve=!1,Je=!0};if(void 0!==window.TWEEN&&"object"==typeof TWEEN){var c=new TWEEN.Tween({t:0}).to({t:1},1e3).onUpdate(function(){var e=this.t,o=a+e*(s-a),p=r+e*(i-r);me.position.set(p*Math.cos(o),t+e*(n-t),p*Math.sin(o)),me.lookAt(new THREE.Vector3(0,-3,0))}).onComplete(p);c.start()}else p()}function T(e,o){var t,n=N(e),r=o.charAt(0),i=o.charAt(1);"w"===r?t=Te.clone():"b"===r&&(t=Me.clone());var a,s;return a=Ae[i],s=new THREE.Mesh(a,t),s.position.x=n.x,s.position.z=n.z,"w"===r&&(s.rotation.y=Math.PI),s.castShadow=!0,s}function R(){var e;for(e=0;8>e;e++)for(var o=3.5*E-E*e,t=0;8>t;t++){var n=E*t-3.5*E,r="abcdefgh".charAt(t)+(e+1),i=e%2===0^t%2===0?Le:We,s=new THREE.BoxGeometry(2,.5,2),p=new THREE.Mesh(s,i.clone());p.position.set(n,-.25,o),s.computeFaceNormals(),s.computeVertexNormals(),p.receiveShadow=!0,Ke[r]=p.id,p.tag=r,Ee.add(p)}var l={size:.5,height:0,weight:"normal",font:"helvetiker",style:"normal",curveSegments:12,steps:1};if(ye=[],a.showNotation){var u,d,f="abcdefgh".split("");for(e=0;8>e;e++){try{u=new THREE.TextGeometry(f[e],l)}catch(h){a.showNotation=!1,c(2354,h);break}d=new THREE.Mesh(u,Ne),d.position.x=2*e-7-l.size/2,d.position.y=-.5,d.position.z=-9,ye.push(d),Ee.add(d),d=new THREE.Mesh(u,ke),d.position.x=2*e-7-l.size/2,d.position.y=-.5,d.position.z=9,ye.push(d),Ee.add(d)}if(ye.length>0){var w="12345678".split("");for(e=0;8>e;e++)u=new THREE.TextGeometry(w[e],l),d=new THREE.Mesh(u,qe),d.position.x=-9,d.position.y=-.5,d.position.z=-7-l.size/2+2*(7-e),ye.push(d),Ee.add(d),d=new THREE.Mesh(u,je),d.position.x=9,d.position.y=-.5,d.position.z=-7-l.size/2+2*(7-e),ye.push(d),Ee.add(d)}}for(var y=0;y<v.length;y++){var m=new THREE.SpotLight(11184810),g=v[y];m.position.set(g[0],g[1],g[2]),m.target=new THREE.Object3D,0===y&&(m.castShadow=!0,m.shadowBias=1e-4,m.shadowDarkness=.2,m.shadowMapWidth=2048,m.shadowMapHeight=2048),Ee.add(m)}var b=new THREE.AmbientLight(5592405);Ee.add(b)}function z(){for(var e in Qe)if(Qe.hasOwnProperty(e)&&!i(e))if(Ue.hasOwnProperty(e)===!1)c(3701,"Square "+e+" in PIECE_MESH_IDS but not in CURRENT_POSITION");else if(!Ee.getObjectById(Qe[e])){c(3702,"Mesh not present on square "+e+", adding a replacement.");var o=T(e,Ue[e]);Ee.add(o),Qe[e]=o.id}for(e in Ue)Ue.hasOwnProperty(e)&&Qe.hasOwnProperty(e)===!1&&c(3703,"Square "+e+" in CURRENT_POSITION but not in PIECE_MESH_IDS")}function M(e,o,t){var n,s;if(Qe.hasOwnProperty(e)&&(s=Ee.getObjectById(Qe[e])),Ke.hasOwnProperty(o)&&(n=Ee.getObjectById(Ke[o])),i(e)&&(s=s.clone(),Ee.add(s)),n&&s){var p=s.position.x,c=s.position.z,l=n.position.x,u=n.position.z,d=new TWEEN.Tween({t:0}).to({t:1},a.moveSpeed).onUpdate(function(){var e=this.t;s.position.x=p+e*(l-p),s.position.z=c+e*(u-c)}).onComplete(function(){Qe[o]=s.id,r(e)&&s.id===Qe[e]&&delete Qe[e],t()});d.start()}}function H(e,o){if(Qe.hasOwnProperty(e)&&r(e)&&Qe.hasOwnProperty(e)){var t=Ee.getObjectById(Qe[e]),n=new TWEEN.Tween({t:1}).to({t:0},a.trashSpeed).onUpdate(function(){t.opacity=this.t}).onComplete(function(){Ee.remove(t),delete Qe[e],o()});n.start()}}function I(e,o,t){var n=T(e,o);n.opacity=0,Ee.add(n);var r=new TWEEN.Tween({t:0}).to({t:1},a.appearSpeed).onUpdate(function(){n.opacity=this.t}).onComplete(function(){Qe[e]=n.id,t()});r.start()}function B(e,t,n){function i(){p--,0===p&&(Y(n),a.hasOwnProperty("moveEnd")&&"function"==typeof a.onMoveEnd&&a.onMoveEnd(o(t,o(n))),Je=!0,z(),Ve=!1)}if(0!==e.length){Ve=!0;var s,p=e.length;for(s=0;s<e.length;s++)"clear"===e[s].type&&r(e[s].square)&&Qe.hasOwnProperty(e[s].square)&&H(e[s].square,i);for(s=0;s<e.length;s++)"move"===e[s].type&&M(e[s].source,e[s].destination,i);for(s=0;s<e.length;s++)if("add"===e[s].type)if(a.sparePieces===!0)for(var c in g)g.hasOwnProperty(c)&&g[c]===e[s].piece&&M(c,e[s].square,i);else I(e[s].square,e[s].piece,i)}}function N(e){var o,t;if(i(e)){var n=e.charCodeAt(2)-"1".charCodeAt(0);o=E*(4*n-10)/3,"w"==e.charAt(1)?t=5*E:"b"==e.charAt(1)&&(t=-5*E)}else r(e)&&(o=E*(e.charCodeAt(0)-"a".charCodeAt(0))-3.5*E,t=3.5*E-E*(e.charCodeAt(1)-"1".charCodeAt(0)));return{x:o,z:t}}function k(e){var o;return i(e)?o=g:r(e)&&(o=Ue),o?o[e]:void 0}function q(e,o){e=e.split("");var t=w.indexOf(e[0])+1,n=parseInt(e[1],10);o=o.split("");var r=w.indexOf(o[0])+1,i=parseInt(o[1],10),a=Math.abs(t-r),s=Math.abs(n-i);return a>=s?a:s}function j(e){var o,t,n=[];for(o=0;8>o;o++)for(t=0;8>t;t++){var r=w[o]+(t+1);e!==r&&n.push({square:r,distance:q(e,r)})}n.sort(function(e,o){return e.distance-o.distance});var i=[];for(o=0;o<n.length;o++)i.push(n[o].square);return i}function _(e,o,t){for(var n=j(t),r=0;r<n.length;r++){var i=n[r];if(e.hasOwnProperty(i)===!0&&e[i]===o)return i}return!1}function W(e,t){var n,r=o(e),i=o(t),a=[];for(n in i)i.hasOwnProperty(n)===!0&&r.hasOwnProperty(n)===!0&&r[n]===i[n]&&(delete r[n],delete i[n]);for(n in i)if(i.hasOwnProperty(n)===!0){var s=_(r,i[n],n);s!==!1&&(a.push({type:"move",source:s,destination:n,piece:i[n]}),delete r[s],delete i[n])}for(n in i)i.hasOwnProperty(n)===!0&&(a.push({type:"add",square:n,piece:i[n]}),delete i[n]);for(n in r)r.hasOwnProperty(n)===!0&&(a.push({type:"clear",square:n,piece:r[n]}),delete r[n]);return a}function D(e,o){var t=new THREE.Vector3(e/ve.domElement.width*2-1,1-o/ve.domElement.height*2,-.5);return t.unproject(me),new THREE.Raycaster(me.position,t.sub(me.position).normalize())}function L(e,o,t){var n=new THREE.Plane(new THREE.Vector3(0,1,0),-t),r=D(e,o),i=r.ray.intersectPlane(n);return i?new THREE.Vector3(i.x,t,i.z):null}function A(e,o){for(var t in Ke)if(Ke.hasOwnProperty(t)){var n=Ee.getObjectById(Ke[t]);if(e>=n.position.x-E/2&&e<n.position.x+E/2&&o>=n.position.z-E/2&&o<n.position.z+E/2)return t}if(a.sparePieces){var r;if(o>=4*E&&6*E>=o)r="w";else{if(!(-4*E>=o&&o>=-6*E))return"offboard";r="b"}var i=Math.round(1+(10-3*e/E)/4);if(i>=1&&6>=i)return t="s"+r+i}return"offboard"}function V(e,o){var t,n,r,i,a=D(e,o),s={},p=[],c=0;for(n in Qe)if(Qe.hasOwnProperty(n)){var l=Ee.getObjectById(Qe[n]);r=k(n);var u=Ae[r.charAt(1)].boundingBox.clone();u.min.x+=l.position.x,u.max.x+=l.position.x,u.min.z+=l.position.z,u.max.z+=l.position.z,t=a.ray.intersectBox(u),t&&(s[n]=t,p.push(l),c++)}if(p.length>0){if(1===p.length)return n=Object.keys(s)[0],t=s[n],i=p[0],{source:n,location:n,piece:k(n),mesh:i,intersection_point:t,off_center_x:t.x-i.position.x,off_center_z:t.z-i.position.z};var d=a.intersectObjects(p);if(d.length>0)for(n in s)if(s.hasOwnProperty(n)&&(i=Ee.getObjectById(Qe[n]),i===d[0].object))return t=d[0].point,{source:n,location:n,piece:k(n),mesh:i,intersection_point:t,off_center_x:t.x-i.position.x,off_center_z:t.z-i.position.z}}var f=L(e,o,0);return f?(n=A(f.x,f.z),r=k(n),i=Ee.getObjectById(Qe[n]),{source:n,location:n,piece:r,mesh:i,intersection_point:new THREE.Vector3(f.x,0,f.z),off_center_x:i?f.x-i.position.x:void 0,off_center_z:i?f.z-i.position.z:void 0}):{source:"offboard",location:"offboard"}}function J(e,o,t){var n=L(o,t,e.intersection_point.y);n&&(n.x-=e.off_center_x,n.z-=e.off_center_z,e.location=A(n.x,n.z),(e.mesh.position.x!==n.x||e.mesh.position.z!==n.z)&&(e.mesh.position.x=n.x,e.mesh.position.z=n.z))}function G(){for(var e in g)if(g.hasOwnProperty(e)){var o=g[e],t=T(e,o);t.position.y=-.5,Qe[e]=t.id,Ee.add(t)}}function U(){if(te(),i($e.source))Ee.remove($e.mesh),$e=null;else{var e=$e.mesh.position.x,t=$e.mesh.position.z,n=Ee.getObjectById(Ke[$e.source]),r=n.position.x,s=n.position.z,p=function(){$e.mesh.position.x=r,$e.mesh.position.z=s;var e=$e.piece,t=$e.source;$e=null,a.hasOwnProperty("onSnapbackEnd")&&"function"==typeof a.onSnapbackEnd&&a.onSnapbackEnd(e,t,o(Ue),Ge),Ve=!1,Je=!0};if(void 0!==window.TWEEN&&"object"==typeof TWEEN){var c=new TWEEN.Tween({t:0}).to({t:1},100).onUpdate(function(){var o=this.t;$e.mesh.position.x=e+o*(r-e),$e.mesh.position.z=t+o*(s-t)}).onComplete(p);c.start()}else p()}}function K(){if(te(),Ee.remove($e.mesh),r($e.source)){var e=o(Ue);delete e[$e.source],Y(e),delete Qe[$e.source]}$e=null}function Q(){te();var e=o(Ue),t=Ee.getObjectById(Ke[$e.location]);$e.mesh.position.x=t.position.x,$e.mesh.position.z=t.position.z,r($e.source)&&(delete e[$e.source],delete Qe[$e.source]),e[$e.location]&&Ee.remove(Ee.getObjectById(Qe[$e.location])),e[$e.location]=$e.piece,Qe[$e.location]=$e.mesh.id;var n=$e.source,i=$e.location,s=$e.piece;$e=null,Y(e),a.hasOwnProperty("onSnapEnd")&&"function"==typeof a.onSnapEnd&&a.onSnapEnd(n,i,s)}function $(){for(var e in Qe)Qe.hasOwnProperty(e)===!0&&(i(e)||(Ee.remove(Ee.getObjectById(Qe[e])),delete Qe[e]));for(var o in Ue)if(Ue.hasOwnProperty(o)===!0){var t=T(o,Ue[o]);Qe[o]=t.id,Ee.add(t)}}function F(){a.sparePieces&&G(),$()}function X(e,t){e=o(e);for(var n in t)if(t.hasOwnProperty(n)===!0&&e.hasOwnProperty(n)===!0){var r=e[n];delete e[n],e[t[n]]=r}return e}function Y(e){var t=o(Ue),n=o(e),r=d(t),i=d(n);r!==i&&(a.hasOwnProperty("onChange")&&"function"==typeof a.onChange&&a.onChange(t,n),Ue=e)}function Z(e,o){o||(o=16776960);var t=Ee.getObjectById(Ke[e]),n=null;if(t){var r=new THREE.TorusGeometry(1.2*E/2,.1,4,4);n=new THREE.Mesh(r,new THREE.MeshBasicMaterial({color:new THREE.Color(o)})),n.position.x=t.position.x,n.position.y=0,n.position.z=t.position.z,n.rotation.z=Math.PI/4,n.rotation.x=Math.PI/2,Ee.add(n)}return n}function ee(){Fe&&(Ee.remove(Fe),Fe=null)}function oe(){Xe&&(Ee.remove(Xe),Xe=null)}function te(){ee(),oe(),Se.removeGreySquares()}function ne(e){ee(),Fe=Z(e)}function re(e){oe(),Xe=Z(e)}function ie(){ge&&(ge.enabled=!1),a.hasOwnProperty("onDragStart")&&"function"==typeof a.onDragStart&&a.onDragStart($e.source,$e.piece,o(Ue),Ge)===!1||(i($e.source)?($e.mesh=$e.mesh.clone(),$e.mesh.position.y=0,Ee.add($e.mesh),Je=!0):r($e.source)&&ne($e.source))}function ae(e,t){var n=$e.location;J($e,e,t),n!==$e.location&&(oe(),r($e.location)&&$e.location!==$e.source&&re($e.location)),a.hasOwnProperty("onDragMove")&&"function"==typeof a.onDragMove&&a.onDragMove($e.location,n,$e.source,$e.piece,o(Ue),Ge)}function se(){var e="drop";if(("offboard"===$e.location||i($e.location))&&("snapback"===a.dropOffBoard&&(e="snapback"),"trash"===a.dropOffBoard&&(e="trash")),a.hasOwnProperty("onDrop")&&"function"==typeof a.onDrop){var t=o(Ue);i($e.source)&&r($e.location)&&(t[$e.location]=$e.piece),r($e.source)&&!r($e.location)&&delete t[$e.source],r($e.source)&&r($e.location)&&(delete t[$e.source],t[$e.location]=$e.piece);var n=o(Ue),s=a.onDrop($e.source,$e.location,$e.piece,t,n,Ge);("snapback"===s||"trash"===s)&&(e=s)}"snapback"===e?U():"trash"===e?K():"drop"===e&&Q(),ge&&(ge.enabled=!0),Je=!0,te()}function pe(e,o){var t,n,r=e.target||e.srcElement,i=r.getBoundingClientRect();return o&&e.touches.length>0?(t=e.touches[0].clientX-i.left,n=e.touches[0].clientY-i.top):(t=e.clientX-i.left,n=e.clientY-i.top),{x:t,y:n}}function ce(e,o){if(e.preventDefault(),!$e&&a.draggable){var t=pe(e,o),n=V(t.x,t.y);n&&void 0!==n.piece?($e=n,Ze="offboard",ie()):ge&&(ge.enabled=!0)}}function le(e,t){e.preventDefault();var n=pe(e,t);if($e)ae(n.x,n.y);else{var i,s;if(a.hasOwnProperty("onMouseoutSquare")&&"function"==typeof a.onMouseoutSquare&&(i=a.onMouseoutSquare),a.hasOwnProperty("onMouseoverSquare")&&"function"==typeof a.onMouseoverSquare&&(s=a.onMouseoverSquare),i||s){var p=V(n.x,n.y).source,c=o(Ue);if(p!==Ze){var l;i&&r(Ze)&&(l=!1,c.hasOwnProperty(Ze)&&(l=c[Ze]),i(Ze,l,c,Ge)),s&&r(p)&&(l=!1,c.hasOwnProperty(p)&&(l=c[p]),s(p,l,c,Ge)),Ze=p}}}}function ue(e){e.preventDefault(),$e&&se()}function de(e){var o;if("function"==typeof a.pieceSet)o=a.pieceSet(e);else if("string"==typeof a.pieceSet){var t=a.pieceSet;o=t.replace("{piece}",e)}var n=new THREE.JSONLoader;a.hasOwnProperty("localStorage")&&a.localStorage===!1&&window.localStorage.removeItem(o);var r=window.localStorage.getItem(o);if(r){var i=JSON.parse(r),s=n.parse(i.data);Ae[e]=s.geometry,Ae[e].computeBoundingBox()}else n.load(o,function(t){Ae[e]=t,t.computeBoundingBox(),(a.hasOwnProperty("localStorage")===!1||a.localStorage!==!1)&&window.localStorage.setItem(o,JSON.stringify(t.toJSON()))})}function fe(){return void 0!==Ae.P&&void 0!==Ae.N&&void 0!==Ae.B&&void 0!==Ae.R&&void 0!==Ae.Q&&void 0!==Ae.K}function he(){function e(){fe()?(F(),t()):setTimeout(e,20)}function t(){requestAnimationFrame(t),void 0!==window.TWEEN&&"object"==typeof window.TWEEN&&TWEEN.update();var e=me.position.clone();ge&&ge.enabled&&ge.update();var n=me.position.x!==e.x||me.position.y!==e.y||me.position.z!==e.z;if(Je||n){var r=me.position.x,i=me.position.y,s=me.position.z;for(var p in ye)ye.hasOwnProperty(p)&&ye[p].lookAt(new THREE.Vector3(100*r,100*i,100*s));-8>=r?(qe.opacity=1,je.opacity=0):r>=8?(qe.opacity=0,je.opacity=1):qe.opacity=je.opacity=1,-8>=s?(Ne.opacity=1,ke.opacity=0):s>=8?(Ne.opacity=0,ke.opacity=1):Ne.opacity=ke.opacity=1}if(Je||null!==$e||Ve||n){var c=!0;if(a.hasOwnProperty("onRender")&&"function"==typeof a.onRender&&a.onRender(Ee,o(Ke),o(Qe),o(Ue))===!1&&(c=!1),c){if(!Pe){for(;we.firstChild;)we.removeChild(we.firstChild);we.appendChild(ve.domElement),Pe=!0}ve.render(Ee,me),Je=!1}else Je=!0}}if(l()===!0&&O()===!0){var n=b;we.style.width&&we.style.width.match(/px/)&&(n=parseInt(we.style.width.replace(/px/,"")));var r=3*n/4;!we.style.height&&we.style.height.match(/px/)&&(r=Math.max(r,parseInt(we.style.height.replace(/px/,"")))),we.style.width=n.toString()+"px",we.style.height=r.toString()+"px",Se.resize(),x(),R(),de("K"),de("Q"),de("R"),de("B"),de("N"),de("P"),e()}}a=a||{};var we,ve,Ee,ye,me,ge,be=u(h),Pe=!1,Se={},Oe=new THREE.Vector3(0,m*Math.cos(y),m*Math.sin(y)),xe=new THREE.Vector3(0,m*Math.cos(y),-m*Math.sin(y)),Ce=11184810;a.hasOwnProperty("whitePieceColor")&&"number"==typeof a.whitePieceColor&&(Ce=a.whitePieceColor);var Te=new THREE.MeshPhongMaterial({color:new THREE.Color(Ce)}),Re=13434879;a.hasOwnProperty("whitePieceSpecular")&&"number"==typeof a.whitePieceSpecular&&(Re=a.whitePieceSpecular),Te.specular=new THREE.Color(Re),Te.transparent=!0;var ze=3355443;a.hasOwnProperty("blackPieceColor")&&"number"==typeof a.blackPieceColor&&(ze=a.blackPieceColor);var Me=new THREE.MeshPhongMaterial({color:new THREE.Color(ze)}),He=5583667;a.hasOwnProperty("blackPieceSpecular")&&"number"==typeof a.blackPieceSpecular&&(He=a.blackPieceSpecular),Me.specular=new THREE.Color(He),Me.transparent=!0;var Ie=0;a.hasOwnProperty("notationColor")&&"number"==typeof a.notationColor&&(Ie=a.notationColor);var Be=new THREE.MeshBasicMaterial({color:new THREE.Color(Ie)});Be.transparent=!0;var Ne=Be.clone(),ke=Be.clone(),qe=Be.clone(),je=Be.clone(),_e=11962467;a.hasOwnProperty("darkSquareColor")&&"number"==typeof a.darkSquareColor&&(_e=a.darkSquareColor);var We=new THREE.MeshPhongMaterial({color:new THREE.Color(_e)}),De=15784373;a.hasOwnProperty("lightSquareColor")&&"number"==typeof a.lightSquareColor&&(De=a.lightSquareColor);var Le=new THREE.MeshPhongMaterial({color:new THREE.Color(De)}),Ae={K:void 0,Q:void 0,R:void 0,B:void 0,N:void 0,P:void 0},Ve=!1,Je=!0,Ge="white",Ue={},Ke={},Qe={},$e=null,Fe=null,Xe=null,Ye=[],Ze="offboard";return Se.clear=function(e){Se.position({},e)},Se.destroy=function(){ve.domElement.removeEventListener("mousedown",ce),ve.domElement.removeEventListener("mousemove",le),ve.domElement.removeEventListener("mouseup",ue),we.removeChild(ve.domElement)},Se.fen=function(){return Se.position("fen")},Se.flip=function(){return Se.orientation("flip")},Se.greySquare=function(e){Ye.push(Z(e,4210752)),Je=!0},Se.removeGreySquares=function(){for(;Ye.length>0;)Ee.remove(Ye.pop());Ye=[],Je=!0},Se.move=function(){if(0!==arguments.length){for(var e=!0,o={},n=0;n<arguments.length;n++)if(arguments[n]!==!1)if(t(arguments[n])===!0){var r=arguments[n].split("-");o[r[0]]=r[1]}else c(2826,"Invalid move passed to the move method.",arguments[n]);else e=!1;var i=X(Ue,o);return Se.position(i,e),i}},Se.orientation=function(e){return 0===arguments.length?Ge:"white"===e||"black"===e?(Ge=e,C("white"===e?Oe:xe),Ge):"flip"===e?(Ge="white"===Ge?"black":"white",C("white"===Ge?Oe:xe),Ge):void c(5482,"Invalid value passed to the orientation method.",e)},Se.flip=function(){Se.orientation("flip")},Se.position=function(e,t){if(0===arguments.length)return o(Ue);if("string"==typeof e&&"fen"===e.toLowerCase())return d(Ue);if(t!==!1&&(t=!0),"string"==typeof e&&"start"===e.toLowerCase()&&(e=o(be)),s(e)===!0&&(e=u(e)),p(e)!==!0)return void c(6482,"Invalid value passed to the position method.",e);var n=function(){if(t===!0&&void 0!==window.TWEEN&&"object"==typeof TWEEN){var o=W(Ue,e);B(o,Ue,e)}else Y(e),$(),Je=!0};if(fe()&&Ve===!1)n();else{var r=function(){fe()===!1||Ve?setTimeout(r,100):n()};r()}},Se.resize=function(){var e=we.clientWidth;e&=65532;var o=e*P;we.style.width=e,we.style.height=o,me&&me.updateProjectionMatrix(),ve&&ve.setSize(we.clientWidth,we.clientHeight),Je=!0},Se.rerender=function(){Je=!0},Se.start=function(e){Se.position("start",e)},he(),Se},window.ChessBoard3.webGLEnabled=e,window.ChessBoard3.fenToObj=u,window.ChessBoard3.objToFen=d}();